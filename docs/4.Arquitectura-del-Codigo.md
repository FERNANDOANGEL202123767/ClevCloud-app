# 4. Arquitectura del Código

## Patrón de Diseño

### Arquitectura General: MVVM + Redux

La aplicación sigue un patrón **MVVM (Model-View-ViewModel)** combinado con **Redux** para gestión de estado centralizada:
![Arquitectura General](/images/mvvm.png)

### Características de la Arquitectura

#### Separación de Responsabilidades

- **View**: Solo presenta datos y captura interacciones del usuario
- **ViewModel (Redux)**: Gestiona lógica de negocio y estado de la UI
- **Model**: Abstrae la comunicación con servicios externos

#### Beneficios

- ✅ Código altamente testeable
- ✅ Componentes reutilizables y desacoplados
- ✅ Estado predecible con Redux
- ✅ Fácil mantenimiento y escalabilidad
- ✅ Separación clara entre UI y lógica de negocio

## Flujo de Datos Completo

### Diagrama de Flujo: Carga de Proyectos

![caraga de proyectos](/images/cargadeproyectos.png)

### Flujo de Búsqueda en Tiempo Real

![flujo](/images/fllujo.png)

## Capas de la Arquitectura

### 1. Capa de Presentación (UI Layer)

#### Componentes de Pantalla

**Ubicación**: `/src/screens/`

```typescript
// HomeScreen.tsx - Responsabilidades
- Renderizar lista de proyectos
- Gestionar búsqueda
- Pull-to-refresh
- Navegación a detalles
- Loading states (skeletons)
- Error handling UI
```

#### Componentes Reutilizables

**Ubicación**: `/src/components/`

**Componentes Common** (sin lógica de negocio):

- Badge, Button, Card, Input, LoadingSpinner
- Presentacionales puros
- Reciben props, emiten eventos

**Componentes Specific** (con lógica de dominio):

- ProjectCard: Conoce estructura de Project
- Transforma datos para presentación

### 2. Capa de Lógica de Negocio (Business Logic Layer)

#### Redux Store

**Ubicación**: `/src/store/`

**Responsabilidades**:

- Estado global de la aplicación
- Lógica de actualización de estado (reducers)
- Efectos secundarios (thunks para async)
- Selectores derivados

**Estructura del State**:

```typescript
{
  projects: {
    projects: Project[],           // Datos originales
    filteredProjects: Project[],   // Datos filtrados por búsqueda
    loading: boolean,              // Estado de carga
    error: string | null,          // Mensaje de error
    searchQuery: string            // Query actual de búsqueda
  }
}
```

#### Custom Hooks

**Ubicación**: `/src/hooks/`

**Propósito**: Encapsular lógica reutilizable

```typescript
// useProjects - Selector especializado
const { projects, loading, error } = useProjects();

// useLoading - Wrapper para async operations
const { loading, error, withLoading } = useLoading();
const data = await withLoading(() => fetchData());

// useAnimation - Gestión de animaciones
const { fadeAnim, fadeIn } = useAnimation();
```

### 3. Capa de Comunicación (Data Layer)

#### API Client

**Ubicación**: `/src/api/client.ts`

**Configuración**:

```typescript
- Base URL desde variables de entorno
- Timeout: 15 segundos
- Headers: Content-Type, Authorization token
- Interceptores de request/response
- Logging automático de requests
```

#### Services

**Ubicación**: `/src/api/services/`

**projectService.ts**:

```typescript
export const projectService = {
  // Obtener todos los proyectos
  getAllProjects(): Promise<Project[]>
  
  // Buscar proyectos (implementación en Redux)
  searchProjects(query: string): Promise<Project[]>
}
```

**Transformación de Datos**:

- Mapeo de API response a interface Project
- Normalización de nombres de campos
- Valores por defecto para campos opcionales
- Validación de tipos

### 4. Capa de Navegación (Navigation Layer)

#### Stack Navigator

**Ubicación**: `/src/navigation/AppNavigator.tsx`

**Configuración**:

```typescript
<Stack.Navigator>
  <Stack.Screen name="Home" component={HomeScreen} />
  <Stack.Screen name="ProjectDetail" component={ProjectDetailScreen} />
</Stack.Navigator>
```

**Características**:

- Type-safe navigation con TypeScript
- Parámetros tipados por pantalla
- Animaciones nativas
- Header configurado

**Tipos de Navegación**:

```typescript
type RootStackParamList = {
  Home: undefined;
  ProjectDetail: { project: Project };
};
```

## Gestión de Estado con Redux Toolkit

### Slice: projectSlice

#### Estado Inicial

```typescript
const initialState: ProjectState = {
  projects: [],
  filteredProjects: [],
  loading: false,
  error: null,
  searchQuery: '',
};
```

#### Actions (Síncronas)

```typescript
// Actualizar query de búsqueda y filtrar
setSearchQuery(state, action: PayloadAction<string>)

// Limpiar error
clearError(state)
```

#### Thunks (Asíncronas)

```typescript
// Cargar proyectos desde API
fetchProjects = createAsyncThunk(
  'projects/fetchProjects',
  async (_, { rejectWithValue }) => {
    try {
      return await projectService.getAllProjects();
    } catch (error) {
      return rejectWithValue(error.message);
    }
  }
);
```

#### Extra Reducers (Manejo de Thunks)

```typescript
builder
  .addCase(fetchProjects.pending, state => {
    state.loading = true;
    state.error = null;
  })
  .addCase(fetchProjects.fulfilled, (state, action) => {
    state.loading = false;
    state.projects = action.payload;
    state.filteredProjects = action.payload;
  })
  .addCase(fetchProjects.rejected, (state, action) => {
    state.loading = false;
    state.error = action.payload as string;
  });
```

## Sistema de Tipos (TypeScript)

### Interfaces Principales

#### Project

```typescript
export interface Project {
  id: string;
  nombre?: string;
  cliente?: string;
  estado?: string;
  descripcion?: string;
  fecha_inicio?: string;
  fecha_fin?: string;
  ubicacion?: string;
  contacto?: string;
  tecnico?: string;
  prioridad?: string;
  progreso?: number;
  [key: string]: any;  // Campos adicionales flexibles
}
```

#### Navigation Types

```typescript
type RootStackParamList = {
  Home: undefined;
  ProjectDetail: { project: Project };
};

type HomeScreenNavigationProp = 
  NativeStackNavigationProp<RootStackParamList, 'Home'>;

type ProjectDetailScreenRouteProp = 
  RouteProp<RootStackParamList, 'ProjectDetail'>;
```

## Manejo de Errores

### Estrategia por Capa

#### UI Layer

```typescript
// ErrorMessage component
<ErrorMessage 
  message={error} 
  onRetry={() => dispatch(fetchProjects())} 
/>
```

#### Redux Layer

```typescript
// Captura en thunk
try {
  return await service.getAllProjects();
} catch (error: any) {
  return rejectWithValue(error.message || 'Error desconocido');
}
```

#### API Layer

```typescript
// Interceptor de errores
apiClient.interceptors.response.use(
  response => response,
  error => {
    console.error('API Error:', error.response?.status);
    return Promise.reject(error);
  }
);
```

## Sistema de Diseño (Design System)

### Tokens de Diseño

#### Colores Semánticos

```typescript
COLORS = {
  primary: '#3B82F6',      // Acciones principales
  secondary: '#8B5CF6',    // Acciones secundarias
  success: '#10B981',      // Estados exitosos
  warning: '#F59E0B',      // Advertencias
  error: '#EF4444',        // Errores
  background: '#F9FAFB',   // Fondo principal
  surface: '#FFFFFF',      // Tarjetas/superficies
  text: '#111827',         // Texto principal
  textSecondary: '#6B7280',// Texto secundario
  border: '#E5E7EB'        // Bordes
}
```

#### Sistema de Espaciado

```typescript
SPACING = {
  xs: 4,    // Espaciado extra pequeño
  sm: 8,    // Espaciado pequeño
  md: 16,   // Espaciado medio (base)
  lg: 24,   // Espaciado grande
  xl: 32,   // Espaciado extra grande
  xxl: 48   // Espaciado doble XL
}
```

#### Tipografía

```typescript
TYPOGRAPHY = {
  h1: 32,      // Títulos principales
  h2: 24,      // Títulos secundarios
  h3: 20,      // Títulos terciarios
  h4: 18,      // Subtítulos
  body: 16,    // Texto normal
  small: 14,   // Texto pequeño
  tiny: 12     // Texto muy pequeño
}
```

#### Sombras

```typescript
SHADOWS = {
  small: {    // Elevación sutil
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 2 },
    shadowOpacity: 0.1,
    shadowRadius: 4,
    elevation: 2
  },
  medium: {   // Elevación media (tarjetas)
    shadowOffset: { width: 0, height: 4 },
    shadowOpacity: 0.15,
    shadowRadius: 8,
    elevation: 4
  },
  large: {    // Elevación alta (modales)
    shadowOffset: { width: 0, height: 8 },
    shadowOpacity: 0.2,
    shadowRadius: 16,
    elevation: 8
  }
}
```

## Optimizaciones de Performance

### FlatList Optimization

```typescript
<FlatList
  data={filteredProjects}
  keyExtractor={item => item.id}
  renderItem={renderItem}
  windowSize={10}                    // Ventana de renderizado
  maxToRenderPerBatch={10}           // Items por batch
  removeClippedSubviews={true}       // Remover items fuera de vista
  initialNumToRender={10}            // Items iniciales
  getItemLayout={getItemLayout}      // Layout precalculado
/>
```

### Memoización

```typescript
// Componentes
const ProjectCard = React.memo(ProjectCardComponent);

// Selectores
const selectFilteredProjects = createSelector(
  [state => state.projects.projects, 
   state => state.projects.searchQuery],
  (projects, query) => filterProjects(projects, query)
);
```

### Reanimated para Animaciones

- Animaciones en UI thread
- 60 FPS garantizados
- Gestos nativos sin lag

## Diagrama de Arquitectura Completo

![full](/images/full.png)