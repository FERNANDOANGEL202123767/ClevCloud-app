# 6. API y Servicios

## Configuración del Cliente HTTP

### Base Configuration

**Protocolo**: HTTPS
 **Content-Type**: application/json
 **Autenticación**: Token en header

```typescript
// Configuración en apiClient.ts
{
  baseURL: process.env.API_BASE_URL,
  timeout: 15000,  // 15 segundos
  headers: {
    'Content-Type': 'application/json',
    token: process.env.API_TOKEN
  }
}
```

### Variables de Entorno Requeridas

```bash
# .env
API_BASE_URL=https://api.ejemplo.com
API_TOKEN=tu_token_secreto_aqui
```

------

## Endpoints Disponibles

### 1. Obtener Todos los Proyectos del Técnico

#### Información General

- **Método**: GET
- **Ruta**: `/vindgroup/all_dataBy_tecnico_2/`
- **Autenticación**: Token requerido
- **Timeout**: 15 segundos

#### Parámetros de Query String

| Parámetro | Tipo   | Requerido | Descripción                |
| --------- | ------ | --------- | -------------------------- |
| usuario   | string | Sí        | ID del técnico (ej: "127") |

#### URL Completa

```
GET {API_BASE_URL}/vindgroup/all_dataBy_tecnico_2/?usuario=127
```

#### Headers

```http
Content-Type: application/json
token: {API_TOKEN}
```

#### Respuesta Exitosa (200 OK)

**Estructura**:

```json
{
  "PROYECTOS_TECNICO": [
    {
      "ID_PROYECTO": "1234",
      "NOMBRE_PROYECTO": "Mantenimiento Parque Eólico Norte",
      "PARQUE": "Parque Norte S.A.",
      "ESTADO": "En Proceso",
      "SERVICIO": "Mantenimiento preventivo de aerogeneradores",
      "COMENTARIOS": "Revisión trimestral programada",
      "FECHA_INICIO": "2025-01-15",
      "FECHA_FIN": "2025-03-30",
      "CONTACTO": "Juan Pérez - +52 123 456 7890",
      "TECNICO_NOMBRE": "Carlos Rodríguez",
      "PRIORIDAD": "Alta",
      "PROGRESO": 65,
      "SUPERVISOR_NOMBRE": "María González",
      "TLIDER": "Roberto Sánchez",
      "AEROGENERADORES": "A01, A02, A03",
      "NUMEROS_AEROGENERADORES": "1, 2, 3"
    },
    {
      "ID_PROYECTO": "1235",
      "NOMBRE_PROYECTO": "Instalación Parque Sur",
      "PARQUE": "Energía Renovable del Sur",
      "ESTADO": "Completado",
      "PROGRESO": 100,
      ...
    }
  ]
}
```

#### Mapeo de Campos

La aplicación transforma los campos del API al modelo interno:

| Campo API               | Campo Interno           | Tipo   | Transformación         |
| ----------------------- | ----------------------- | ------ | ---------------------- |
| ID_PROYECTO / ID        | id                      | string | String(value)          |
| NOMBRE_PROYECTO         | nombre                  | string | Directo                |
| PARQUE                  | cliente y ubicacion     | string | Directo                |
| ESTADO                  | estado                  | string | Directo                |
| SERVICIO / COMENTARIOS  | descripcion             | string | SERVICIO o COMENTARIOS |
| FECHA_INICIO            | fecha_inicio            | string | Directo (ISO format)   |
| FECHA_FIN               | fecha_fin               | string | Directo (ISO format)   |
| CONTACTO                | contacto                | string | Directo                |
| TECNICO_NOMBRE          | tecnico                 | string | Directo                |
| PRIORIDAD               | prioridad               | string | Directo                |
| PROGRESO                | progreso                | number | Number(value)          |
| SUPERVISOR_NOMBRE       | supervisor              | string | Directo                |
| TLIDER                  | tlider                  | string | Directo                |
| AEROGENERADORES         | aerogeneradores         | string | Directo                |
| NUMEROS_AEROGENERADORES | numeros_aerogeneradores | string | Directo                |

#### Código de Transformación

```typescript
const mappedData: Project[] = rawData.map((item: any) => ({
  id: String(item.ID_PROYECTO || item.ID || 'unknown'),
  nombre: item.NOMBRE_PROYECTO || 'Sin nombre',
  cliente: item.PARQUE || 'Sin cliente',
  estado: item.ESTADO || undefined,
  descripcion: item.SERVICIO || item.COMENTARIOS || undefined,
  fecha_inicio: item.FECHA_INICIO || undefined,
  fecha_fin: item.FECHA_FIN || undefined,
  ubicacion: item.PARQUE || undefined,
  contacto: item.CONTACTO || undefined,
  tecnico: item.TECNICO_NOMBRE || undefined,
  prioridad: item.PRIORIDAD || undefined,
  progreso: item.PROGRESO !== undefined ? Number(item.PROGRESO) : undefined,
  supervisor: item.SUPERVISOR_NOMBRE || undefined,
  tlider: item.TLIDER || undefined,
  aerogeneradores: item.AEROGENERADORES || undefined,
  numeros_aerogeneradores: item.NUMEROS_AEROGENERADORES || undefined,
}));
```

#### Respuestas de Error

##### 401 Unauthorized

```json
{
  "error": "Token inválido o expirado"
}
```

##### 403 Forbidden

```json
{
  "error": "No tiene permisos para acceder a este recurso"
}
```

##### 404 Not Found

```json
{
  "error": "Endpoint no encontrado"
}
```

##### 500 Internal Server Error

```json
{
  "error": "Error interno del servidor"
}
```

##### Timeout (15s)

```
Network Error: timeout of 15000ms exceeded
```

#### Ejemplos de Petición

##### JavaScript/TypeScript (Axios)

```typescript
import axios from 'axios';

const response = await axios.get(
  'https://api.ejemplo.com/vindgroup/all_dataBy_tecnico_2/',
  {
    params: { usuario: '127' },
    headers: {
      'Content-Type': 'application/json',
      token: 'tu_token_aqui'
    },
    timeout: 15000
  }
);

const projects = response.data.PROYECTOS_TECNICO;
```

##### cURL

```bash
curl -X GET \
  'https://api.ejemplo.com/vindgroup/all_dataBy_tecnico_2/?usuario=127' \
  -H 'Content-Type: application/json' \
  -H 'token: tu_token_aqui' \
  --max-time 15
```

------

## Manejo de Errores en la Aplicación

### Interceptores de Axios

#### Request Interceptor

```typescript
apiClient.interceptors.request.use(
  config => {
    console.log('✈ Request:', config.method?.toUpperCase(), config.url);
    return config;
  },
  error => {
    console.error('✘ Request Error:', error);
    return Promise.reject(error);
  }
);
```

**Propósito**: Logging de todas las peticiones salientes.

#### Response Interceptor

```typescript
apiClient.interceptors.response.use(
  response => {
    console.log('✔ Response:', response.config.url, response.status);
    return response;
  },
  error => {
    console.error('✘ Response Error:', error.response?.status, error.message);
    return Promise.reject(error);
  }
);
```

**Propósito**: Logging de respuestas y errores para debugging.

### Estrategia de Manejo de Errores

#### En el Servicio (projectService.ts)

```typescript
try {
  const response = await apiClient.get(ENDPOINTS.ALL_PROJECTS);
  const rawData = response.data.PROYECTOS_TECNICO || [];
  
  if (!Array.isArray(rawData)) {
    console.warn('API returned non-array data');
    return [];
  }
  
  return mappedData;
} catch (error) {
  console.error('Error fetching projects:', error);
  throw error;  // Propagar error para manejo en Redux
}
```

#### En Redux Thunk (projectSlice.ts)

```typescript
export const fetchProjects = createAsyncThunk(
  'projects/fetchProjects',
  async (_, { rejectWithValue }) => {
    try {
      return await projectService.getAllProjects();
    } catch (error: any) {
      return rejectWithValue(
        error.message || 'Error al cargar proyectos'
      );
    }
  }
);
```

#### En el Componente (HomeScreen.tsx)

```typescript
if (error) {
  return (
    <ErrorMessage 
      message={error} 
      onRetry={() => dispatch(fetchProjects())} 
    />
  );
}
```

------

## Códigos de Estado HTTP

| Código  | Significado         | Manejo en la App                        |
| ------- | ------------------- | --------------------------------------- |
| 200     | OK                  | Procesar datos normalmente              |
| 401     | Unauthorized        | Mostrar error de autenticación          |
| 403     | Forbidden           | Mostrar error de permisos               |
| 404     | Not Found           | Mostrar error de endpoint no encontrado |
| 500     | Server Error        | Mostrar error del servidor              |
| 503     | Service Unavailable | Mostrar error de servicio no disponible |
| Timeout | Network Timeout     | Mostrar error de timeout con retry      |

------

## Seguridad

### Protección del Token

1. **Variables de Entorno**:
   - Token almacenado en `.env`
   - Archivo `.env` en `.gitignore`
   - No hardcodear tokens en código
2. **Transmisión Segura**:
   - Usar siempre HTTPS
   - Token en header, no en URL
3. **Rotación de Tokens**:
   - Implementar mecanismo de refresh (futuro)
   - Expiración de tokens controlada en backend

### Validación de Datos

```typescript
// Validar estructura antes de usar
if (!Array.isArray(rawData)) {
  console.warn('Invalid data format');
  return [];
}

// Valores por defecto para campos críticos
const id = String(item.ID_PROYECTO || item.ID || 'unknown');
const nombre = item.NOMBRE_PROYECTO || 'Sin nombre';
```

------

## Performance y Optimización

### Timeout Configurado

```typescript
timeout: 15000  // 15 segundos
```

**Razón**: Balance entre dar tiempo suficiente para respuestas lentas y no bloquear la UI indefinidamente.

------

## Testing de Endpoints

### Herramienta

- **Postman**: Para testing manual

